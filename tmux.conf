# Tmux configuration file
#
# Sources:
#   http://blog.hawkhost.com/2009/07/02/tmux--the-terminal-multiplexer-part-2/
#   https://upcase.com/tmux
#  
#  Requirements:
#      * fzf: https://github.com/junegunn/fzf
#      * tat: https://github.com/thoughtbot/dotfiles/blob/master/bin/tat
#      * Tmux Plugin Manager: https://github.com/tmux-plugins/tpm
#      * Tmux 1.9+ (<= plugin tmux resurrect)
#      * ansifilter (on OsX, for tmux logging): brew install ansifilter
#      * urlview (on MacOS only, for tmux-urlview): brew install urlview
#      * fpp    brew install fpp
#
# -------------------
# Tmux in a few words
# -------------------
# Tmux Server
#   +-- Session
#         +-- Window
#               +---- Pane
#
# A tmux server hosts muliple sessions.
# Multiple tmux servers can run at the same time.
#    tmux ls  # list existing sessions in a tmux server
#    tmux attach -t SESSION_NAME  # Open the session SESSION_NAME
#
# A tmux session is a logical grouping of windows.
# Multiple sessions can run at the same time.
# Selecting a session gives you acces to the windows it s composed of.
#
# A window looks like a tab you can select.
# Once you choose a window, the panes it is composed of become visible.
#
# A pane is rectangular area within a windoww within which you interact 
# as you do in a regular terminal.

#--------------
# Tmux commands
# -------------
# bind-key          is aliased bind
# unbind-key        is aliased unbind
# set-window-option is aliased set-w
# set-option        is aliased set
#
# list-commands   # List tmux sub commands
# list-keys       # List tmux key mappings

# ~~~~~~~~~~~~~~~
#   Key Bindings
# ~~~~~~~~~~~~~~~
# Action Key binding: Use C-a instead of C-b as a prefix for any command
# To send <Control>-a to an application running within tmux simply by press CTRL-a twice.
set -g prefix C-a
bind C-a send-prefix

# Release the defaut prefix  <Control>b  so that it can be used for something else
unbind C-b

# use emacs key bindings
set-w -g mode-keys emacs

# <Prefix>r  reloads tmux config file
unbind r
bind r source-file ~/.tmux.conf \; display "~/.tmux.conf reloaded!"

# <Control>s  forward-incremental-history-search
bind C-s send-prefix -2


#~~~~~~~~~~~~~~
#  Terminal
#~~~~~~~~~~~~~~
# Uncomment in case arrows do not work in vi, when in 256 colors
set -g default-terminal "screen-256color"
set -g history-limit 20000


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Copy and Paste
#   tmux list-keys -t vi-copy  # List key bindings
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Use vim keybindings in copy mode
setw -g mode-keys vi

# <v>  Enter selection (aka vi-copy) mode as in Vim
bind -t vi-copy v begin-selection

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Create sessions
# ~~~~~~~~~~~~~~~~~~~
# <Control>b  Create a new session named after the directory of the current pane
# Requires: tat
bind C-b send-keys 'tat && exit' 'C-m'

# <Prefix>K   Kill the current session and switch to another one (without leaving tmux)
bind-key K run-shell 'tmux switch-client -n \; kill-session -t "$(tmux display-message -p "#S")" || tmux kill-session'

# ~~~~~~~~~~~~~~~~~~~
# Session navigation
# ~~~~~~~~~~~~~~~~~~~
# <Prefix><Control>j   lists existing sessions (use C-n to go down or C-p to go up)
bind C-j choose-tree

# <Prefix><Control>j  Fuzzy finder to switch to another session
#   Requires fzf: https://github.com/junegunn/fzf
bind C-j split-window -v "tmux list-sessions | sed -E 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse | xargs tmux switch-client -t"

# <Prefix>L    jump to previous session
# <Prefix>d    detach from current session

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Windows
# ~~~~~~~~~~~~~~~~~~~
# <Prefix>c  create a new window
bind c new-window -c "#{pane_current_path}"

# Keep the window name fixed
setw -g automatic-rename off 
set  -g allow-rename off

# Window and Pane Numbering 
set -g  base-index      1 # Window numbering start at 1 (instead of 0 by default).
setw -g pane-base-index 1 # Pane numvering start at 1
set -g renumber-windows on # Renumber windows as they are created and destroyed 
                           #   to keep the window numbers consistent with the count.

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Panes
# ~~~~~~~~~~~~~~~~~~~
# New panes are created in the directory of the current pane 
# <Prefix>- split window vertically
bind | split-window -h -c '#{pane_current_path}'

# <Prefix>| split window horizontally
bind - split-window -v -c '#{pane_current_path}'

# <Prefix>b break the current pane into a new window
bind b break-pane -d

# <Prefix>h Run htop in a pane on the right
bind h split-window -h "htop || top"

# <Prefix>g Show Rails development logs
bind g split-window -h -c '#{pane_current_path}' 'tail -f log/development.log'

# <Prefix>z  zomm in/out the current pane

# ~~~~~~~~~~~~~~~~~~~
# Resize Panes
# ~~~~~~~~~~~~~~~~~~~
# Fine adjustment (1 or 2 cursor cells per bump)
bind -n S-Left  resize-pane -L 2
bind -n S-Right resize-pane -R 2
bind -n S-Down  resize-pane -D 1
bind -n S-Up    resize-pane -U 1

# Resize current pane (5 or 10 cursor cells per bump)
bind -n C-Left  resize-pane -L 10
bind -n C-Right resize-pane -R 10
bind -n C-Down  resize-pane -D 5
bind -n C-Up    resize-pane -U 5

#~~~~~~~~~~~~~~~~~~~~
# Pane Navigation
#~~~~~~~~~~~~~~~~~~~~
is_vim='echo "#{pane_current_command}" | grep -iqE "(^|\/)g?(view|n?vim?)(diff)?$"'
# <Control>h  Goto left pane
bind -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
# <Control>h  Goto pane below
bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
# <Control>k  Goto pane above
bind -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
# <Control>l  Goto right pane
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"
# <Control>\  Goto last pane
bind -n C-\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"

# Prompted join-pane
bind j command-prompt -p "join pane from: "  "join-pane -h -s '%%'"

# Easily swap a pane (targeted by pane number) with the current pane
bind s display-panes\; command-prompt -p "pane #: "  "swap-pane -t '%%'"

#~~~~~~~~~~~~~~~~~~~~
# Window Navigation
#~~~~~~~~~~~~~~~~~~~~
" <Alt><Left Arrow> got to previous window
bind -n M-Left  previous-window

" <Alt><Right Arrow> got next window
bind -n M-Right next-window

# ~~~~~~~~~~~~~
#   Colours
# ~~~~~~~~~~~~~

# Colours: Inactive Window: cyan 
setw -g window-status-fg cyan
setw -g window-status-bg default
setw -g window-status-attr dim

# Colours: Active Window: red
setw -g window-status-current-fg white
setw -g window-status-current-bg red
setw -g window-status-current-attr bright

# Colours: Pane Divider
set -g pane-border-fg green
set -g pane-border-bg black
set -g pane-active-border-fg white
set -g pane-active-border-bg yellow

# Colours: Command Line: White text on a black background
set -g message-fg white
set -g message-bg black
set -g message-attr bright

# Highlight active window 
set-window-option -g window-status-current-bg red

# ~~~~~~~~~~~~~
#   Mouse
# ~~~~~~~~~~~~~
# Enable mouse scroll when in scroll mode (ActionKey + [ )
# Click on a pane to give it the focus
# Use Shift + mouse to select/paste text
if-shell "[[ $(tmux -V) == *2.1 ]]" "set -g mouse on"
if-shell "[[ $(tmux -V) == *2.0 || $(tmux -V) == *1.* ]]" \
    'setw -g mode-mouse on;  \
    set -g mouse-select-pane on; \
    set -g mouse-resize-pane on; \
    set -g mouse-select-window on'


# scroll with the mouse wheels
# 
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind -n WheelDownPane select-pane -t= \; send-keys -M

#~~~~~~~~~~~~~~
#  Status Bar
#~~~~~~~~~~~~~~
# Colours: Status Bar: Light gray
set -g status-bg '#666666'
set -g status-fg '#aaaaaa'

# status-left command tells tmux to display the following text to the left of the terminal. 
# The [fg=green]#H portion tells tmux to display the hostname of localhost and make it green.
# The #H portion is part of tmux variable expansion 
# Requires tmux-plugins/tmux-battery
set -g status-right '#(uptime | cut -d "," -f 3-) | Online: #{online_status} | #{battery_icon} #{battery_percentage} #{battery_remain} | %a %h-%d %H:%M '
set -g status-right-length 90

# Refresh the status bar every minute
set -g status-interval 60

#~~~~~~~~~~~~~~
# Window notifications
#~~~~~~~~~~~~~~
# tmux notifies you in the status area when a window has activity
#
setw -g monitor-activity on
set  -g visual-activity on

#~~~~~~~~~~~~~~
# Center the window list
#~~~~~~~~~~~~~~
set -g status-justify centre


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#  OS Specific configuration
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~
if-shell 'test "$(uname)" = "Darwin"' 'source ~/.tmux-macos.conf'
if-shell 'test "$(uname)" = "Linux"' 'source ~/.tmux-linux.conf'


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# List of tmux plugins
#   <prefix><I>  Install / load the tmux plugins
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Tmux Plugin Manager Installation:
#   git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
set -g @plugin 'tmux-plugins/tpm'

#  Make sessions, windows, panes layout persistent accross tmux restart
#      <Prefix><Control><S>  Save
#      <Prefix><Control><R>  Restore
set -g @plugin 'tmux-plugins/tmux-resurrect' 

# Battery
set -g @plugin 'tmux-plugins/tmux-battery'

set -g @plugin 'tmux-plugins/tmux-online-status'

# Enable logging of all output in the current pane
# <Prefix<><Shift><p>        Toggle (start/stop) logging of the current pane
# <Prefix<><Esc><Shift><p>   Saves complete pane history to a file
# <Prefix><Esc><c>           Clear pane history
set -g @plugin 'tmux-plugins/tmux-logging'
set -g history-limit 50000

# On MacOS only, requires either of:
#   * urlview: brew install urlview
#   * extract_url: brew install extract_url
#
#   <Prefix><u>    List all URLs in a bottom pane
set -g @plugin 'tmux-plugins/tmux-urlview'

# Facebook Path Picker: 
# use f in any mode
#   requires fpp:   brew install fpp
set -g @plugin 'tmux-plugins/tmux-fpp'

# Solarized colour theme for tmux
set -g @plugin 'seebi/tmux-colors-solarized'
set -g @colors-solarized 'dark'

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Initialize TMUX plugin manager
#
# Keep this line at the very bottom of tmux.conf
# <prefix>I  Loads the tmux plugins declared
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~
run '~/.tmux/plugins/tpm/tpm'

